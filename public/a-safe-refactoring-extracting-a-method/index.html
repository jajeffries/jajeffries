<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>A safe refactoring: extracting a method</title>
	
	
	<link rel="stylesheet" href="/blog/css/style.css">
	
	
</head>
<body>
	<header>
	==========<br>
	== <a href="https://jajeffries.com/blog/">Blog</a> ==<br>
	==========
	<div style="float: right;">Your blog subtitle goes here!</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/blog/posts/"><b>Posts</b></a>.
			
			<a href="/blog/categories/"><b>Categories</b></a>.
			
			<a href="/blog/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>A safe refactoring: extracting a method</h1>
			<b><time>12.05.2015 12:08</time></b>
		       
		           <a href="/tags/uncategorized">Uncategorized</a>
        	       

			<div>
				<p>Sometimes you have some code that is duplicated in multiple places. One approach to getting rid of this would be to extract it into a method. In this article I&rsquo;ll show you two different approaches you can take to do this and when I would use each one. <strong>Setting the scene</strong> I&rsquo;m going to use the example of some tests for the <a href="http://codekata.com/kata/kata09-back-to-the-checkout/">checkout kata</a>. Let&rsquo;s say we&rsquo;ve reached the following code [code] class CheckoutTests &lt; Test::Unit::TestCase def test_scanning_one_a prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} checkout = Checkout.new(prices) checkout.scan(&lsquo;A&rsquo;) assert_equal(50, checkout.total) end def test_scanning_multiple_items prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} checkout = Checkout.new(prices) checkout.scan(&lsquo;A&rsquo;) checkout.scan(&lsquo;B&rsquo;) assert_equal(120, checkout.total) end end [/code] We have some duplication in the code where we set up our Checkout. [code] prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} checkout = Checkout.new(prices) [/code] <strong>Basic method extraction</strong> So let&rsquo;s start off by adding a method which returns our Checkout. This is basically <a href="http://refactoring.com/catalog/extractMethod.html">Martin Fowler&rsquo;s Extract Method refactoring</a>. We&rsquo;ll just do this in one of the tests to start off with to make sure we aren&rsquo;t making to big a change in one go. [code] def new_checkout prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} Checkout.new(prices) end def test_scanning_one_a checkout = new_checkout checkout.scan(&lsquo;A&rsquo;) assert_equal(50, checkout.total) end [/code] For me this feels like quite a jump so lets take a step back and see if we can break this down into a smaller step. We can use (or abuse) the fact that you can call a method in ruby without brackets to our advantage here. If we first assign our checkout to a variable called [code]new_checkout[/code]. [code] def test_scanning_one_a prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;:70} new_checkout = Checkout.new(prices) checkout = new_checkout checkout.scan(&lsquo;A&rsquo;) assert_equal(50, checkout.total) end [/code] Then we can move out the instantiation of our checkout into a method called [code]new_checkout[/code]. [code] def new_checkout prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;:70} Checkout.new(prices) end def test_scanning_one_a checkout = new_checkout checkout.scan(&lsquo;A&rsquo;) assert_equal(50, checkout.total) end [/code] This is only a slightly smaller step, but as we are running our tests after each change it can give us more confidence that what we are doing is working, and if it&rsquo;s not then we can press undo (or git stash) and try the refactor again from the last point where the tests passed. We can now apply the same to our other test method. [code] class CheckoutTests &lt; Test::Unit::TestCase def new_checkout prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;:70} Checkout.new(prices) end def test_scanning_one_a checkout = new_checkout checkout.scan(&lsquo;A&rsquo;) assert_equal(50, checkout.total) end def test_scanning_multiple_items checkout = new_checkout checkout.scan(&lsquo;A&rsquo;) checkout.scan(&lsquo;B&rsquo;) assert_equal(120, checkout.total) end end [/code] <strong>Extract to method using fields</strong> Let&rsquo;s go back to our original test before we started refactoring. [code] class CheckoutTests &lt; Test::Unit::TestCase def test_scanning_one_a prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} checkout = Checkout.new(prices) checkout.scan(&lsquo;A&rsquo;) assert_equal(50, checkout.total) end def test_scanning_multiple_items prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} checkout = Checkout.new(prices) checkout.scan(&lsquo;A&rsquo;) checkout.scan(&lsquo;B&rsquo;) assert_equal(120, checkout.total) end end [/code] This time we will try and break this down into steps in a different way. We&rsquo;ll start by assigning our checkout to a field. [code] def test_scanning_one_a prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} @checkout = Checkout.new(prices) @checkout.scan(&lsquo;A&rsquo;) assert_equal(50, @checkout.total) end [/code] Now we&rsquo;ll move the setup into a different method called [code]setup_checkout[/code]. [code] def setup_checkout prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;:70} @checkout = Checkout.new(prices) end def test_scanning_one_a setup_checkout @checkout.scan(&lsquo;A&rsquo;) assert_equal(50, @checkout.total) end [/code] This has required less changes in our existing code so far. We can now use our [code]setup_checkout[/code] method in our second test by simply assigning our checkout to a field again and then removing the first two lines. This would leave us with something like: [code] class CheckoutTests &lt; Test::Unit::TestCase def setup_checkout prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} @checkout = Checkout.new(prices) end def test_scanning_one_a setup_checkout @checkout.scan(&lsquo;A&rsquo;) assert_equal(50, @checkout.total) end def test_scanning_multiple_items setup_checkout @checkout.scan(&lsquo;A&rsquo;) @checkout.scan(&lsquo;B&rsquo;) assert_equal(120, @checkout.total) end end [/code] In fact this works quite well as a test setup so we can rename our [code]setup_checkout[/code] method to [code]setup[/code] and removing the calls to it so that it is run before each test by the test framework. This leaves us with: [code] class CheckoutTests &lt; Test::Unit::TestCase def setup prices = {&lsquo;A&rsquo;:50, &lsquo;B&rsquo;: 70} @checkout = Checkout.new(prices) end def test_scanning_one_a @checkout.scan(&lsquo;A&rsquo;) assert_equal(50, @checkout.total) end def test_scanning_multiple_items @checkout.scan(&lsquo;A&rsquo;) @checkout.scan(&lsquo;B&rsquo;) assert_equal(120, @checkout.total) end end [/code] <strong>Summary</strong> We&rsquo;ve looked at two approaches to doing this refactoring. Firstly we extracted a method to return a new checkout. I would probably use this if I was wanting to abstract away something complicated or dirty that would hinder readability. The second approach where we used assigned our checkout to a field on the object and used that everywhere instead. In the example we used I would probably prefer this approach. We&rsquo;ve moved the repeated algorithm (setting up the checkout) to state, which in this case I think is simpler and more readable. While this has been a very simple example, practicing refactorings in this situation means that we have more options in our toolkit when we are working on real code. Hopefully you can see how taking small steps allows us to evaluate why we have chosen to use particular refactorings and help you think using about different approaches.</p>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/blog/pages/about-me/">About me</a></li>
				
				<li><a href="/blog/pages/talks/">Talks</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2024 <a href="https://jajeffries.com/blog/"><b>Blog</b></a>.
	<a href="https://github.com/example"><b>Github</b></a>.
	<a href="https://example.com/@user"><b>Mastodon</b></a>.
	<a href="/blog/imprint"><b>Imprint</b></a>.
	</p>
</footer>

</body>
</html>
